<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MMA – Gestión de Peleas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">
<div class="container py-4">
  <h2 class="mb-3">Peleas</h2>
  <p class="text-secondary mb-4">
    Programa peleas entre peleadores y registra el estado y ganador.
  </p>

  <div class="row g-4">
    <!-- FORM -->
    <div class="col-md-4">
      <div class="card bg-secondary-subtle text-dark">
        <div class="card-body">
          <h5 class="card-title" id="formTitle">Nueva pelea</h5>
          <form id="formFight" autocomplete="off">
            <input type="hidden" id="fightId">

            <div class="mb-2">
              <label class="form-label mb-0" for="fighter1">Peleador 1</label>
              <select class="form-select" id="fighter1" required></select>
            </div>

            <div class="mb-2">
              <label class="form-label mb-0" for="fighter2">Peleador 2</label>
              <select class="form-select" id="fighter2" required></select>
            </div>

            <div class="mb-2">
              <label class="form-label mb-0" for="rounds">Rounds</label>
              <input type="number" min="1" max="5" value="3" class="form-control" id="rounds">
            </div>

            <div class="mb-2">
              <label class="form-label mb-0" for="winner">Ganador (opcional)</label>
              <select class="form-select" id="winner">
                <option value="">Sin definir</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label mb-0" for="status">Estado</label>
              <select class="form-select" id="status">
                <option>Scheduled</option>
                <option>InProgress</option>
                <option>Finished</option>
                <option>Cancelled</option>
              </select>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-warning flex-fill" id="btnSave">Guardar</button>
              <button type="button" class="btn btn-outline-dark d-none" id="btnCancelEdit">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="col-md-8">
      <div class="card bg-body-tertiary text-dark">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">Listado de peleas</h5>
            <button class="btn btn-sm btn-outline-secondary" id="btnReload">Recargar</button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-striped table-hover align-middle mb-0">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Peleador 1</th>
                  <th>Peleador 2</th>
                  <th>Rounds</th>
                  <th>Ganador</th>
                  <th>Estado</th>
                  <th style="width: 130px;"></th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="7" class="text-center">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// APIs (para Live Server)
const FIGHT_API   = 'http://localhost:8081/api/fights';
const FIGHTER_API = 'http://localhost:8081/api/fighters';

let fighters = [];

const tbody      = document.getElementById('tbody');
const form       = document.getElementById('formFight');
const fightId    = document.getElementById('fightId');
const fighter1   = document.getElementById('fighter1');
const fighter2   = document.getElementById('fighter2');
const winnerSel  = document.getElementById('winner');
const roundsInp  = document.getElementById('rounds');
const statusSel  = document.getElementById('status');
const formTitle  = document.getElementById('formTitle');
const btnCancel  = document.getElementById('btnCancelEdit');
const btnReload  = document.getElementById('btnReload');

function optionLabel(f) {
  return `${f.id} - ${f.firstName} ${f.lastName}`;
}

function fillFighterSelects() {
  const opts = fighters.map(f => `<option value="${f.id}">${optionLabel(f)}</option>`).join('');
  fighter1.innerHTML  = '<option value="" disabled selected>Seleccione peleador 1</option>' + opts;
  fighter2.innerHTML  = '<option value="" disabled selected>Seleccione peleador 2</option>' + opts;
  winnerSel.innerHTML = '<option value="">Sin definir</option>' + opts;
}

async function loadFighters() {
  const res = await fetch(FIGHTER_API);
  if (!res.ok) throw new Error('Error cargando peleadores: ' + res.status);
  fighters = await res.json();
  fillFighterSelects();
}

async function loadFights() {
  try {
    const res = await fetch(FIGHT_API);
    if (!res.ok) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error al cargar: ' + res.status + '</td></tr>';
      return;
    }
    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay peleas registradas.</td></tr>';
      return;
    }
    tbody.innerHTML = data.map(f => `
      <tr>
        <td>${f.id}</td>
        <td>${f.fighter1 ? (f.fighter1.firstName + ' ' + f.fighter1.lastName) : ''}</td>
        <td>${f.fighter2 ? (f.fighter2.firstName + ' ' + f.fighter2.lastName) : ''}</td>
        <td>${f.rounds ?? ''}</td>
        <td>${f.winner ? (f.winner.firstName + ' ' + f.winner.lastName) : '—'}</td>
        <td>${f.status ?? ''}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-warning me-1" onclick="editFight(${f.id})">Editar</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteFight(${f.id})">Eliminar</button>
        </td>
      </tr>
    `).join('');
  } catch (err) {
    console.error(err);
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error de red al cargar peleas.</td></tr>';
  }
}

async function getFight(id) {
  const res = await fetch(`${FIGHT_API}/${id}`);
  if (!res.ok) throw new Error('No se pudo obtener la pelea');
  return await res.json();
}

window.editFight = async function(id) {
  try {
    const f = await getFight(id);
    fightId.value = f.id;
    fighter1.value = f.fighter1 ? f.fighter1.id : '';
    fighter2.value = f.fighter2 ? f.fighter2.id : '';
    winnerSel.value = f.winner ? f.winner.id : '';
    roundsInp.value = f.rounds ?? 3;
    statusSel.value = f.status ?? 'Scheduled';
    formTitle.textContent = 'Editar pelea #' + f.id;
    btnCancel.classList.remove('d-none');
  } catch (err) {
    alert('No se pudo cargar la pelea: ' + err.message);
  }
};

window.deleteFight = async function(id) {
  if (!confirm('¿Seguro que deseas eliminar la pelea #' + id + '?')) return;
  try {
    const res = await fetch(`${FIGHT_API}/${id}`, { method: 'DELETE' });
    if (!res.ok) {
      const txt = await res.text();
      alert('Error al eliminar (' + res.status + '): ' + txt);
      return;
    }
    await loadFights();
  } catch (err) {
    alert('Error de red al eliminar: ' + err.message);
  }
};

function resetForm() {
  fightId.value = '';
  form.reset();
  roundsInp.value = 3;
  statusSel.value = 'Scheduled';
  formTitle.textContent = 'Nueva pelea';
  btnCancel.classList.add('d-none');
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const isEdit = !!fightId.value;

  if (!fighter1.value || !fighter2.value) {
    alert('Debes seleccionar ambos peleadores.');
    return;
  }
  if (fighter1.value === fighter2.value) {
    alert('Los dos peleadores no pueden ser el mismo.');
    return;
  }

  const body = {
    fighter1Id: Number(fighter1.value),
    fighter2Id: Number(fighter2.value),
    winnerId: winnerSel.value ? Number(winnerSel.value) : null,
    rounds: roundsInp.value ? Number(roundsInp.value) : 3,
    status: statusSel.value
  };

  const url = isEdit ? `${FIGHT_API}/${fightId.value}` : FIGHT_API;
  const method = isEdit ? 'PUT' : 'POST';

  try {
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const txt = await res.text();
    if (!res.ok) {
      alert('Error ' + res.status + '\\n' + txt);
      return;
    }
    resetForm();
    await loadFights();
  } catch (err) {
    alert('Error de red al guardar: ' + err.message);
  }
});

btnCancel.addEventListener('click', resetForm);
btnReload.addEventListener('click', loadFights);

// Inicial
(async function init() {
  try {
    await loadFighters();
    await loadFights();
  } catch (err) {
    console.error(err);
    alert('Error inicial: ' + err.message);
  }
})();
</script>
</body>
</html>
