<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MMA ‚Äì Gesti√≥n de Peleas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --mma-red: #dc2626;
      --mma-dark: #0f0f0f;
      --mma-gold: #fbbf24;
      --mma-steel: #374151;
    }
    body {
      background: linear-gradient(135deg, var(--mma-dark) 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      font-family: 'Oswald', sans-serif;
    }
    .page-header {
      background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
      padding: 1.5rem 0;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
    }
    .page-header h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.5rem;
      letter-spacing: 3px;
      margin: 0;
      text-transform: uppercase;
      color: #000;
    }
    .card {
      border: none;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    .card-form {
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      border-left: 4px solid var(--mma-gold);
    }
    .card-form .card-title {
      color: var(--mma-gold);
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.5rem;
      letter-spacing: 2px;
    }
    .card-table {
      background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
    }
    .card-table .card-title {
      color: #f3f4f6;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.5rem;
      letter-spacing: 2px;
    }
    .form-control, .form-select {
      background: #374151;
      border: 1px solid #4b5563;
      color: #f9fafb;
      border-radius: 8px;
    }
    .form-control:focus, .form-select:focus {
      background: #4b5563;
      border-color: var(--mma-gold);
      color: #fff;
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
    }
    .form-label {
      color: #9ca3af;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .btn-warning {
      background: linear-gradient(90deg, var(--mma-gold) 0%, #d97706 100%);
      border: none;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 0.6rem 1.5rem;
      color: #000;
      transition: all 0.3s ease;
    }
    .btn-warning:hover {
      background: linear-gradient(90deg, #fcd34d 0%, var(--mma-gold) 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(251, 191, 36, 0.4);
      color: #000;
    }
    .table {
      color: #e5e7eb;
    }
    .table thead {
      background: linear-gradient(90deg, var(--mma-gold) 0%, #d97706 100%);
    }
    .table thead th {
      border: none;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.8rem;
      padding: 1rem 0.75rem;
      color: #000;
    }
    .table tbody tr {
      transition: all 0.2s ease;
    }
    .table tbody tr:hover {
      background: rgba(251, 191, 36, 0.1);
    }
    .table-striped>tbody>tr:nth-of-type(odd) {
      background-color: rgba(55, 65, 81, 0.3);
    }
    .badge-scheduled { background: #3b82f6; }
    .badge-inprogress { background: #f59e0b; animation: pulse 1.5s infinite; }
    .badge-finished { background: #10b981; }
    .badge-cancelled { background: #6b7280; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .fighter-name {
      font-weight: 600;
    }
    .vs-badge {
      background: var(--mma-red);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
    }
    .winner-highlight {
      color: var(--mma-gold);
      font-weight: bold;
    }
    .btn-outline-warning {
      color: var(--mma-gold);
      border-color: var(--mma-gold);
    }
    .btn-outline-warning:hover {
      background: var(--mma-gold);
      color: #000;
    }
    .btn-outline-danger {
      color: #f87171;
      border-color: #f87171;
    }
    .btn-outline-danger:hover {
      background: #ef4444;
      color: #fff;
    }
    .back-link {
      color: #1f2937;
      text-decoration: none;
      transition: color 0.2s;
    }
    .back-link:hover {
      color: #000;
    }
    .round-badge {
      background: var(--mma-steel);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
    }
  </style>
</head>
<body class="text-light">
<div class="page-header">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <h2>‚öîÔ∏è Peleas</h2>
      <a href="/index.html" class="back-link">‚Üê Volver al inicio</a>
    </div>
  </div>
</div>

<div class="container pb-5">
  <div class="row g-4">
    <!-- FORM -->
    <div class="col-lg-4">
      <div class="card card-form">
        <div class="card-body p-4">
          <h5 class="card-title" id="formTitle">Nueva Pelea</h5>
          <form id="formFight" autocomplete="off">
            <input type="hidden" id="fightId">

            <div class="mb-3">
              <label class="form-label" for="fighter1">Peleador 1 (Esquina Roja)</label>
              <select class="form-select" id="fighter1" required></select>
            </div>

            <div class="mb-3">
              <label class="form-label" for="fighter2">Peleador 2 (Esquina Azul)</label>
              <select class="form-select" id="fighter2" required></select>
            </div>

            <div class="mb-3">
              <label class="form-label" for="rounds">N√∫mero de Rounds</label>
              <input type="number" min="1" max="5" value="3" class="form-control" id="rounds">
            </div>

            <div class="mb-3">
              <label class="form-label" for="winner">Ganador</label>
              <select class="form-select" id="winner">
                <option value="">Sin definir (pendiente)</option>
              </select>
            </div>

            <div class="mb-4">
              <label class="form-label" for="status">Estado</label>
              <select class="form-select" id="status">
                <option value="Scheduled">Programada</option>
                <option value="InProgress">En Progreso</option>
                <option value="Finished">Finalizada</option>
                <option value="Cancelled">Cancelada</option>
              </select>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-warning flex-fill" id="btnSave">üíæ Guardar</button>
              <button type="button" class="btn btn-outline-light d-none" id="btnCancelEdit">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="col-lg-8">
      <div class="card card-table">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Cartelera de Peleas</h5>
            <button class="btn btn-sm btn-outline-light" id="btnReload">üîÑ Recargar</button>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Pelea</th>
                  <th>Rounds</th>
                  <th>Ganador</th>
                  <th>Estado</th>
                  <th style="width: 140px;"></th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="6" class="text-center py-4">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// URLs din√°micas - detecta autom√°ticamente el host
const FIGHT_API   = window.location.origin + '/api/public/bouts';
const FIGHTER_API = window.location.origin + '/api/public/fighters';
const ADMIN_API   = window.location.origin + '/api/admin';
const token = localStorage.getItem('mma_token');

function getAuthHeaders() {
    return token ? { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}` 
    } : { 'Content-Type': 'application/json' };
}

let fighters = [];

const tbody      = document.getElementById('tbody');
const form       = document.getElementById('formFight');
const fightId    = document.getElementById('fightId');
const fighter1   = document.getElementById('fighter1');
const fighter2   = document.getElementById('fighter2');
const winnerSel  = document.getElementById('winner');
const roundsInp  = document.getElementById('rounds');
const statusSel  = document.getElementById('status');
const formTitle  = document.getElementById('formTitle');
const btnCancel  = document.getElementById('btnCancelEdit');
const btnReload  = document.getElementById('btnReload');

function getStatusBadge(status) {
  const badges = {
    'Scheduled': '<span class="badge badge-scheduled">Programada</span>',
    'InProgress': '<span class="badge badge-inprogress">üî¥ EN VIVO</span>',
    'Finished': '<span class="badge badge-finished">Finalizada</span>',
    'Cancelled': '<span class="badge badge-cancelled">Cancelada</span>'
  };
  return badges[status] || status;
}

function optionLabel(f) {
  return `${f.firstName} ${f.lastName} (${f.recordW || 0}-${f.recordL || 0})`;
}

function fillFighterSelects() {
  const opts = fighters.map(f => `<option value="${f.id}">${optionLabel(f)}</option>`).join('');
  fighter1.innerHTML  = '<option value="" disabled selected>Seleccionar peleador</option>' + opts;
  fighter2.innerHTML  = '<option value="" disabled selected>Seleccionar peleador</option>' + opts;
  winnerSel.innerHTML = '<option value="">Sin definir (pendiente)</option>' + opts;
}

async function loadFighters() {
  const res = await fetch(FIGHTER_API);
  if (!res.ok) throw new Error('Error cargando peleadores: ' + res.status);
  fighters = await res.json();
  fillFighterSelects();
}

async function loadFights() {
  try {
    const res = await fetch(FIGHT_API);
    if (!res.ok) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-4">Error al cargar: ' + res.status + '</td></tr>';
      return;
    }
    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No hay peleas programadas. ¬°Crea la primera!</td></tr>';
      return;
    }
    tbody.innerHTML = data.map(f => {
      const f1Name = f.fighter1 ? `${f.fighter1.firstName} ${f.fighter1.lastName}` : '?';
      const f2Name = f.fighter2 ? `${f.fighter2.firstName} ${f.fighter2.lastName}` : '?';
      const winnerName = f.winner 
        ? `<span class="winner-highlight">üèÜ ${f.winner.firstName} ${f.winner.lastName}</span>` 
        : '<span class="text-muted">‚Äî</span>';
      
      return `
        <tr>
          <td><span class="text-muted">#${f.id}</span></td>
          <td>
            <span class="fighter-name">${f1Name}</span>
            <span class="vs-badge mx-2">VS</span>
            <span class="fighter-name">${f2Name}</span>
          </td>
          <td><span class="round-badge">${f.rounds || 3} Rds</span></td>
          <td>${winnerName}</td>
          <td>${getStatusBadge(f.status)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-warning me-1" onclick="editFight(${f.id})">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteFight(${f.id})">üóëÔ∏è</button>
          </td>
        </tr>
      `;
    }).join('');
  } catch (err) {
    console.error(err);
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-4">Error de red al cargar peleas.</td></tr>';
  }
}

async function getFight(id) {
  const res = await fetch(`${FIGHT_API}/${id}`);
  if (!res.ok) throw new Error('No se pudo obtener la pelea');
  return await res.json();
}

window.editFight = async function(id) {
  try {
    const f = await getFight(id);
    fightId.value = f.id;
    fighter1.value = f.fighter1 ? f.fighter1.id : '';
    fighter2.value = f.fighter2 ? f.fighter2.id : '';
    winnerSel.value = f.winner ? f.winner.id : '';
    roundsInp.value = f.rounds ?? 3;
    statusSel.value = f.status ?? 'Scheduled';
    formTitle.textContent = 'Editar Pelea #' + f.id;
    btnCancel.classList.remove('d-none');
  } catch (err) {
    alert('No se pudo cargar la pelea: ' + err.message);
  }
};

window.deleteFight = async function(id) {
  if (!token) {
    alert('Debes iniciar sesi√≥n para eliminar peleas');
    window.location.href = '/login.html';
    return;
  }
  if (!confirm('¬øSeguro que deseas eliminar la pelea #' + id + '?')) return;
  try {
    const res = await fetch(`${ADMIN_API}/bouts/${id}`, { 
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) {
      const txt = await res.text();
      alert('Error al eliminar (' + res.status + '): ' + txt);
      return;
    }
    await loadFights();
  } catch (err) {
    alert('Error de red al eliminar: ' + err.message);
  }
};

function resetForm() {
  fightId.value = '';
  form.reset();
  roundsInp.value = 3;
  statusSel.value = 'Scheduled';
  formTitle.textContent = 'Nueva Pelea';
  btnCancel.classList.add('d-none');
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!token) {
    alert('Debes iniciar sesi√≥n para crear/editar peleas');
    window.location.href = '/login.html';
    return;
  }
  
  const isEdit = !!fightId.value;

  if (!fighter1.value || !fighter2.value) {
    alert('Debes seleccionar ambos peleadores.');
    return;
  }
  if (fighter1.value === fighter2.value) {
    alert('Los dos peleadores no pueden ser el mismo.');
    return;
  }

  const body = {
    fighter1Id: Number(fighter1.value),
    fighter2Id: Number(fighter2.value),
    winnerId: winnerSel.value ? Number(winnerSel.value) : null,
    rounds: roundsInp.value ? Number(roundsInp.value) : 3,
    status: statusSel.value
  };

  const url = isEdit ? `${ADMIN_API}/bouts/${fightId.value}` : `${ADMIN_API}/bouts`;
  const method = isEdit ? 'PUT' : 'POST';

  try {
    const res = await fetch(url, {
      method,
      headers: getAuthHeaders(),
      body: JSON.stringify(body)
    });
    const txt = await res.text();
    if (!res.ok) {
      alert('Error ' + res.status + '\n' + txt);
      return;
    }
    resetForm();
    await loadFights();
  } catch (err) {
    alert('Error de red al guardar: ' + err.message);
  }
});

btnCancel.addEventListener('click', resetForm);
btnReload.addEventListener('click', loadFights);

// Inicial
(async function init() {
  try {
    await loadFighters();
    await loadFights();
  } catch (err) {
    console.error(err);
    alert('Error inicial: ' + err.message);
  }
})();
</script>
</body>
</html>
